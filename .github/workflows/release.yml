name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  packages: write

jobs:
  build-and-release:
    name: Build and Release
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.23'

    - name: Get version from tag
      id: get_version
      run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

    - name: Build binaries for all platforms
      run: |
        mkdir -p dist

        platforms=(
          "linux/amd64"
          "linux/arm64"
          "darwin/amd64"
          "darwin/arm64"
          "windows/amd64"
        )

        for platform in "${platforms[@]}"; do
          IFS='/' read -r GOOS GOARCH <<< "$platform"
          output_name="agentmcp-${GOOS}-${GOARCH}"
          if [ "$GOOS" = "windows" ]; then
            output_name="${output_name}.exe"
          fi

          echo "Building for ${GOOS}/${GOARCH}..."
          CGO_ENABLED=0 GOOS=$GOOS GOARCH=$GOARCH go build \
            -ldflags="-s -w -X main.VERSION=${{ steps.get_version.outputs.VERSION }}" \
            -o "dist/${output_name}" \
            .
        done

    - name: Create checksums
      run: |
        cd dist
        sha256sum * > checksums.txt

    - name: Create release notes
      id: release_notes
      run: |
        cat > release_notes.md <<EOF
        ## AgentMCP v${{ steps.get_version.outputs.VERSION }}

        ### Installation

        Download the appropriate binary for your platform and make it executable:

        **Linux (AMD64)**:
        \`\`\`bash
        curl -L -o agentmcp https://github.com/${{ github.repository }}/releases/download/v${{ steps.get_version.outputs.VERSION }}/agentmcp-linux-amd64
        chmod +x agentmcp
        \`\`\`

        **macOS (Apple Silicon)**:
        \`\`\`bash
        curl -L -o agentmcp https://github.com/${{ github.repository }}/releases/download/v${{ steps.get_version.outputs.VERSION }}/agentmcp-darwin-arm64
        chmod +x agentmcp
        \`\`\`

        ### Docker

        \`\`\`bash
        docker pull ghcr.io/${{ github.repository }}:v${{ steps.get_version.outputs.VERSION }}
        \`\`\`

        ### Quick Start

        \`\`\`bash
        ./agentmcp -agents ./agents -transport stdio
        \`\`\`

        See the [README](https://github.com/${{ github.repository }}) for full documentation.
        EOF

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          dist/*
        body_path: release_notes.md
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  docker-release:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    needs: build-and-release

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Get version from tag
      id: get_version
      run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        platforms: linux/amd64,linux/arm64
        push: true
        tags: |
          ghcr.io/${{ github.repository }}:latest
          ghcr.io/${{ github.repository }}:v${{ steps.get_version.outputs.VERSION }}
        build-args: |
          VERSION=${{ steps.get_version.outputs.VERSION }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
